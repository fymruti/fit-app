<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Fit App — loader</title>
<style>
:root{--bg:#f8fafc;--ink:#0f172a;--accent:#2563eb}
body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--ink);display:flex;align-items:center;justify-content:center;height:100vh}
.loader{width:520px;max-width:92%;background:#fff;border-radius:12px;padding:18px;box-shadow:0 8px 30px rgba(2,6,23,.08);text-align:center}
h1{margin:0 0 8px 0;font-size:18px}
p.small{margin:6px 0;color:#475569;font-size:13px}
.btn{display:inline-block;margin:8px;padding:8px 12px;border-radius:8px;background:var(--accent);color:#fff;text-decoration:none;cursor:pointer}
.status{margin-top:10px;font-size:13px;color:#334155}
</style>
</head>
<body>
  <div class="loader" role="region" aria-live="polite">
    <h1>Fit App — loader aktualizacji</h1>
    <p class="small">Sprawdzam dostępne wersje i ładuję najnowszą aplikację z serwera...</p>
    <div id="actions">
      <a id="btnManual" class="btn">Sprawdź teraz</a>
      <a id="btnRollback" class="btn" style="background:#64748b">Przywróć kopię</a>
    </div>
    <div id="status" class="status">Status: oczekiwanie...</div>
    <div style="margin-top:10px;font-size:12px;color:#94a3b8">Wersja loadera: 12.0.5</div>
  </div>

<script>
const MANIFEST_URL = 'https://fymruti.github.io/fit-app/update_v12_0_5.json'; // ustaw swoje
const APP_STORE_NS = 'fit_app_store_v1';
const LOADER_VERSION = '12.0.5';
const statusEl = document.getElementById('status');
const btn = document.getElementById('btnManual');
const rb = document.getElementById('btnRollback');

function setStatus(t, err=false){ statusEl.textContent = 'Status: '+t; statusEl.style.color = err ? '#b91c1c' : '#334155'; }

async function fetchJSON(url, timeout=10000){
  const ctrl = new AbortController();
  const t = setTimeout(()=>ctrl.abort(), timeout);
  try{
    const r = await fetch(url, {cache:'no-cache', signal: ctrl.signal});
    if(!r.ok) throw new Error('HTTP '+r.status);
    return await r.json();
  }finally{ clearTimeout(t); }
}

function saveBackup(html, version){
  try{
    const key = `${APP_STORE_NS}:backup:${version}`;
    localStorage.setItem(key, html);
    const historyKey = `${APP_STORE_NS}:history`;
    const h = JSON.parse(localStorage.getItem(historyKey)||'[]');
    h.push({version, at: new Date().toISOString()});
    localStorage.setItem(historyKey, JSON.stringify(h));
  }catch(e){ console.warn('backup err', e); }
}

function downloadAsFile(text, name){
  const blob = new Blob([text], {type:'text/html;charset=utf-8'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = name;
  document.body.appendChild(a);
  a.click();
  a.remove();
}

async function loadLatest(){
  try{
    setStatus('sprawdzam manifest...');
    const m = await fetchJSON(MANIFEST_URL);
    if(!m || !m.latest_version || !m.file) { setStatus('błędny manifest', true); return; }
    setStatus('znaleziono v'+m.latest_version+' — pobieram...');
    const resp = await fetch(m.file, {cache:'no-cache'});
    if(!resp.ok) { setStatus('błąd pobierania', true); return; }
    const newHtml = await resp.text();

    // backup current document HTML (if any)
    try{
      const currentHtml = '<!doctype html>\n' + document.documentElement.outerHTML;
      saveBackup(currentHtml, m.latest_version || 'pre-'+Date.now());
    }catch(e){ console.warn('backup fail', e); }

    // inject new HTML (replace current document)
    setStatus('ładowanie nowej wersji...');
    const w = window.open('', '_self');
    w.document.open();
    w.document.write(newHtml);
    w.document.close();
  }catch(err){
    console.error(err);
    setStatus('błąd: '+(err.message||err), true);
  }
}

function rollback(){
  try{
    const histKey = `${APP_STORE_NS}:history`;
    const hist = JSON.parse(localStorage.getItem(histKey)||'[]');
    if(!hist.length) { alert('Brak kopii do przywrócenia'); return; }
    const last = hist.pop();
    localStorage.setItem(histKey, JSON.stringify(hist));
    const key = `${APP_STORE_NS}:backup:${last.version}`;
    const html = localStorage.getItem(key);
    if(!html){ alert('Brak danych kopii'); return; }
    // pobierz jako plik do otwarcia
    downloadAsFile(html, `fit-all-in-one_v${last.version}_backup.html`);
    setStatus('pobrano kopię v'+last.version);
  }catch(e){ console.error(e); alert('Błąd przywracania'); }
}

btn.addEventListener('click', ()=>{ loadLatest(); });
rb.addEventListener('click', ()=>{ rollback(); });

// Auto-check on load (manual mode preferred: only check at start)
window.addEventListener('load', ()=>{
  setStatus('inicjalizacja...');
  // small delay to let UI show
  setTimeout(()=>{
    loadLatest();
  }, 300);
});
</script>
</body>
</html>
