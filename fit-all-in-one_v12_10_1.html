<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>FIT – v12.10.1</title>
<style>
:root{--bg:#f2f5f9;--ink:#0f172a;--ink-soft:#475569;--accent:#3b82f6;--accent2:#8b5cf6;--card:#fff;--input:#f8fafc;--border:#cbd5e1}
body.dark{--bg:#0b1220;--ink:#e5edf6;--ink-soft:#9fb0c9;--accent:#60a5fa;--accent2:#7c3aed;--card:#121a2b;--input:#0f172a;--border:#334155}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--ink)}
header{position:sticky;top:0;z-index:10;padding:10px;background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff}
.tabs{display:flex;gap:8px;flex-wrap:wrap}
.tabs button{padding:8px 12px;border:none;border-radius:10px;cursor:pointer;background:#fff;color:#0f172a;font-weight:600}
body.dark .tabs button{background:#1e293b;color:#e2e8f0}
.tabs button.active{background:#0f172a;color:#fff}
.rightbar{display:flex;gap:8px;align-items:center;margin-top:8px}
main{max-width:1200px;margin:0 auto;padding:12px}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;margin:10px 0}
.hidden{display:none}
.row-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
label{display:block;margin-top:6px;font-weight:700;font-size:13px}
input,select,textarea{width:100%;margin-top:4px;padding:8px;border:1px solid var(--border);border-radius:10px;background:var(--input);color:var(--ink)}
select option{color:#0f172a} body.dark select option{color:#e2e8f0}
.kpi{display:flex;gap:8px;flex-wrap:wrap}
.kpi .pill{background:#fff;color:#0f172a;border:1px solid var(--border);border-radius:999px;padding:4px 8px;font-size:12px}
body.dark .kpi .pill{background:#1e293b;color:#e2e8f0;border-color:#334155}
.figure-wrap img{width:100%;border-radius:12px;border:1px solid var(--border);background:#000}
.gallery{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
.gallery img{width:78px;height:96px;object-fit:cover;border:1px solid var(--border);border-radius:8px;cursor:pointer;background:#000}
.legend{font-size:12px;color:var(--ink-soft)}
canvas{width:100%;height:180px;display:block;background:#fff;border-radius:10px;border:1px solid var(--border)}
body.dark canvas{background:#0b1220}
/* Onboarding modal */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.65);display:none;align-items:center;justify-content:center;padding:16px;z-index:100}
.modal .win{background:var(--card);border:1px solid var(--border);border-radius:14px;max-width:820px;width:100%;padding:14px}
.modal h2{margin:6px 0 6px 0}
.disc{font-size:12px;color:var(--ink-soft)}
.disabled{opacity:.55;pointer-events:none}
/* Photo viewer 720p */
.viewer{position:fixed;inset:0;background:rgba(0,0,0,.75);display:none;align-items:center;justify-content:center;padding:20px;z-index:90}
.viewer .box{background:#000;border-radius:12px;max-width:1280px;width:100%;padding:10px;position:relative}
.viewer img{width:100%;height:auto}
.viewer .close{position:absolute;top:8px;right:8px;background:#fff;border:none;border-radius:8px;padding:6px 10px;cursor:pointer}
</style>
</head>
<body>
<header>
  <div class="tabs" id="tabs">
    <button class="active" data-tab="start">Start</button>
    <button data-tab="sylwetka">Sylwetka</button>
    <button data-tab="dieta">Dieta</button>
    <button data-tab="jedzenie">Jedzenie</button>
    <button data-tab="trening">Trening</button>
    <button data-tab="suple">Suple</button>
    <button data-tab="opcje">Opcje</button>
  </div>
  <div class="rightbar">
    <button id="btnTheme">🌙/☀️</button>
  </div>
</header>

<main>
  <!-- START -->
  <section id="start">
    <div class="card">
      <h2>FIT v12.10.1</h2>
      <div class="kpi">
        <div class="pill">Tryb: <b id="modeInfo">light</b></div>
        <div class="pill">Data: <b id="dateInfo">—</b></div>
      </div>
      <p class="legend">Nowość: <b>Onboarding (1 raz)</b> + przyciski w Opcjach do ponownego otwarcia/edycji. Dane są migracyjne i nie znikają przy aktualizacjach.</p>
    </div>
    <div class="card">
      <h3>🎯 Pytania wstępne</h3>
      <div class="row-3">
        <div><label>Cel treningowy</label><select id="trainGoal"><option value="kondycja">Poprawić kondycję</option><option value="miesnie">Zbudować mięśnie</option><option value="sila">Zwiększyć siłę</option><option value="redukcja">Redukcja tłuszczu</option></select></div>
        <div><label>Miejsce treningu</label><select id="trainPlace"><option value="silownia">Siłownia</option><option value="dom">Dom</option></select></div>
        <div><label>Suplementy?</label><select id="suppWant"><option value="nie">Nie</option><option value="tak">Tak</option></select></div>
      </div>
      <div class="row-2">
        <div id="suppLevelWrap" class="hidden"><label>Poziom suplementacji</label><select id="suppLevel"><option value="minimalna">Minimalna</option><option value="umiarkowana">Umiarkowana</option><option value="rozszerzona">Rozszerzona</option><option value="pelna">Pełna</option></select></div>
        <div><label>Aktywność (TDEE)</label><select id="tdeeActivity"><option value="1.2">Siedzący</option><option value="1.375">Lekko aktywny</option><option value="1.55" selected>Umiarkowany</option><option value="1.725">Aktywny</option><option value="1.9">Bardzo aktywny</option></select></div>
      </div>
    </div>
  </section>

  <!-- SYLWETKA -->
  <section id="sylwetka" class="hidden">
    <div class="card">
      <h3>🧍 Dawid + zdjęcia</h3>
      <div class="figure-wrap">
        <img alt="Dawid"
          src="data:image/svg+xml;utf8,<?xml version='1.0'?><svg xmlns='http://www.w3.org/2000/svg' width='640' height='960'><rect width='100%' height='100%' fill='black'/><text x='50%' y='50%' fill='white' font-size='32' text-anchor='middle'>Dawid – podgląd</text></svg>"/>
      </div>
      <div class="row-2" style="margin-top:8px">
        <div><label>Data zdjęcia</label><input type="date" id="photoDate"></div>
        <div><label>Dodaj zdjęcia (max 5/dzień)</label><input type="file" id="photoFile" accept="image/*" multiple></div>
      </div>
      <div class="gallery" id="photoGallery"></div>
    </div>
    <div class="card">
      <h3>📉 Wykres (demo)</h3>
      <canvas id="mChart" width="360" height="180"></canvas>
    </div>
  </section>

  <!-- DIETA -->
  <section id="dieta" class="hidden">
    <div class="row-3">
      <div class="card"><h3>🍽️ Śniadanie</h3><div id="bMeals"></div></div>
      <div class="card"><h3>🍛 Obiad</h3><div id="lMeals"></div></div>
      <div class="card"><h3>🥗 Kolacja</h3><div id="dMeals"></div></div>
    </div>
    <div class="row-2">
      <div class="card"><h3>📝 Uwagi</h3><textarea id="dietNotes" rows="5" placeholder="np. bez laktozy, mniej glutenu..."></textarea></div>
      <div class="card"><h3>🍴 Moje dania (stałe)</h3><textarea id="myMeals" rows="5" placeholder="- Jajecznica PRO P35/C10/F20..."></textarea></div>
    </div>
  </section>

  <!-- JEDZENIE -->
  <section id="jedzenie" class="hidden">
    <div class="card">
      <h3>🛒 Lista zakupów</h3>
      <textarea id="shoppingList" rows="6" placeholder="- ryż 2 kg&#10;- pierś z kurczaka 2 kg..."></textarea>
    </div>
  </section>

  <!-- TRENING -->
  <section id="trening" class="hidden">
    <div class="card"><h3>🏋️‍♂️ Dzisiejszy trening</h3><div class="legend">Plan treningowy jak w GymRun (demo). Linki YT i szablony w kolejnych wersjach.</div></div>
  </section>

  <!-- SUPLE -->
  <section id="suple" class="hidden">
    <div class="card" style="text-align:center;padding:40px"><h2>💊 Suplementy</h2><p>Moduł będzie dodany później.</p></div>
  </section>

  <!-- OPCJE -->
  <section id="opcje" class="hidden">
    <div class="card">
      <h3>⚙️ Opcje</h3>
      <div class="row-2">
        <div>
          <label>Folder danych lokalnych (dla raportów / eksportu)</label>
          <input id="dataFolder" placeholder="C:\FIT\Data\">
          <div class="legend">Jeśli wskażesz inny katalog, Agent może z niego czytać pliki (Windows). W przeglądarce zapis odbywa się przez pobieranie.</div>
        </div>
        <div>
          <label>&nbsp;</label>
          <button id="btnSaveFolder">💾 Zapisz folder</button>
          <button id="btnShowOnboarding">Pokaż onboarding</button>
          <button id="btnEditOnboarding">Edytuj dane startowe</button>
          <button id="btnTDEE">TDEE</button>
        </div>
      </div>
      <div id="folderInfo" class="legend" style="margin-top:6px"></div>
    </div>
  </section>
</main>

<!-- Onboarding modal (once) -->
<div class="modal" id="welcomeModal">
  <div class="win">
    <h2>Witaj w FIT</h2>
    <p class="disc">To okno pojawia się <b>tylko raz</b> (możesz je otworzyć ponownie w Opcjach). Podane dane zapisujemy trwało w Twojej przeglądarce.</p>
    <div class="row-3">
      <div><label>Nazwa użytkownika</label><input id="obName" placeholder="np. Sebastian"></div>
      <div><label>Email (wyłączone)</label><input id="obEmail" placeholder="twoj@email" disabled class="disabled"></div>
      <div><label>Data urodzenia</label><input id="obDob" type="date"></div>
    </div>
    <h3 style="margin-top:8px">⚙️ TDEE (jednorazowo)</h3>
    <div class="row-3">
      <div><label>Płeć</label><select id="tdeeGender"><option value="m">Mężczyzna</option><option value="k">Kobieta</option></select></div>
      <div><label>Wiek</label><input id="tdeeAge" type="number"></div>
      <div><label>Wzrost [cm]</label><input id="tdeeHeight" type="number" step="0.1"></div>
    </div>
    <div class="row-3">
      <div><label>Waga [kg]</label><input id="tdeeWeight" type="number" step="0.1"></div>
      <div><label>Aktywność</label><select id="tdeeActivityOb"><option value="1.2">Siedzący</option><option value="1.375">Lekko aktywny</option><option value="1.55" selected>Umiarkowany</option><option value="1.725">Aktywny</option><option value="1.9">Bardzo aktywny</option></select></div>
      <div><label>&nbsp;</label><button id="btnCalcTDEE">Oblicz</button></div>
    </div>
    <div class="legend" id="tdeeOut">BMR: — | Utrzymanie: — | Redukcja (15%): — | Masa (+10%): —</div>
    <div style="margin-top:10px;text-align:right">
      <button id="btnSaveOnboarding">Zapisz</button>
    </div>
  </div>
</div>

<!-- Photo viewer 720p -->
<div class="viewer" id="photoModal">
  <div class="box">
    <button class="close" id="closeModal">Zamknij ✖</button>
    <img id="modalImg" alt="Podgląd 720p"/>
  </div>
</div>

<script>
(()=>{
  // ===== Persistence with migration (stable key) =====
  const KEY='fit_store'; // stable store key across versions
  const OLD_KEYS=['fit_v129_data','fit_v1210']; // previous keys to migrate from
  const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));

  function load(){
    try{
      const raw=localStorage.getItem(KEY);
      if(raw){ return JSON.parse(raw); }
      // migrate if old keys exist
      for(const k of OLD_KEYS){
        const r=localStorage.getItem(k);
        if(r){
          try{
            const o=JSON.parse(r);
            const migrated = normalize(o);
            save(migrated);
            return migrated;
          }catch(e){/* ignore */}
        }
      }
      // default fresh
      return normalize({});
    }catch(e){ return normalize({}); }
  }
  function save(o){ localStorage.setItem(KEY, JSON.stringify(o)); }
  function normalize(o){
    return {
      meta: { version: '12.10.1', created_at: o?.meta?.created_at || new Date().toISOString() },
      user: o.user || { name:'', dob:'', email:'' },
      tdee: o.tdee || null,
      prefs: o.prefs || { goal:'kondycja', place:'silownia', suppWant:'nie', suppLevel:'minimalna', activity:1.55 },
      measurements: o.measurements || [],
      photos: o.photos || [],
      diet: o.diet || { notes:'', myMeals:'' },
      shopping: o.shopping || { list:'' },
      workout: o.workout || {},
      opts: o.opts || { dataFolder:'' },
      onboarded: !!o.onboarded
    };
  }

  /* ===== Tabs & Theme ===== */
  function showTab(id){ $$('main > section').forEach(s=>s.classList.add('hidden')); const el=document.getElementById(id); if(el) el.classList.remove('hidden'); }
  function initTabs(){ const bar=$('#tabs'); const first=bar.querySelector('button.active')||bar.querySelector('button[data-tab]'); if(first) showTab(first.dataset.tab);
    bar.addEventListener('click',e=>{ const b=e.target.closest('button[data-tab]'); if(!b) return; $$('#tabs button').forEach(x=>x.classList.toggle('active',x===b)); showTab(b.dataset.tab); }); }
  function applyTheme(){ $('#modeInfo').textContent=document.body.classList.contains('dark')?'dark':'light'; }
  function toggleTheme(){ document.body.classList.toggle('dark'); applyTheme(); renderChart(); }

  /* ===== Onboarding + TDEE ===== */
  function mifflin(sex,kg,cm,age){ return Math.max(0, sex==='m' ? (10*kg+6.25*cm-5*age+5) : (10*kg+6.25*cm-5*age-161)); }
  function calcTDEEOnce(){
    const sex=$('#tdeeGender').value;
    const age=+($('#tdeeAge').value||0);
    const cm=+($('#tdeeHeight').value||0);
    const kg=+($('#tdeeWeight').value||0);
    const act=+($('#tdeeActivityOb').value||1.55);
    if(!(age&&cm&&kg)){ $('#tdeeOut').textContent='Uzupełnij: płeć, wiek, wzrost, wagę.'; return; }
    const bmr=Math.round(mifflin(sex,kg,cm,age));
    const tdee=Math.round(bmr*act);
    const cut=Math.round(tdee*0.85);
    const bulk=Math.round(tdee*1.10);
    $('#tdeeOut').textContent=`BMR: ${bmr} | Utrzymanie: ${tdee} | Redukcja (15%): ${cut} | Masa (+10%): ${bulk}`;
    const st=load();
    st.tdee={sex,age,height:cm,weight:kg,activity:act,bmr,tdee,cutPct:15,bulkPct:10,cutKcal:cut,bulkKcal:bulk};
    save(st);
  }
  function saveOnboarding(){
    const st=load();
    st.user.name=$('#obName').value.trim();
    st.user.dob=$('#obDob').value;
    // email zostaje wyłączony
    // Mapowanie do pomiarów (pierwszy wpis):
    // jeśli podano wzrost/wagę w TDEE -> dodaj/aktualizuj pomiar na dziś
    const cm=+($('#tdeeHeight').value||0);
    const kg=+($('#tdeeWeight').value||0);
    const today = new Date().toISOString().slice(0,10);
    if(cm||kg){
      st.measurements = st.measurements || [];
      st.measurements = st.measurements.filter(m=>m.date!==today);
      st.measurements.push({date:today, height: (cm||null), weight:(kg||null)});
      st.measurements.sort((a,b)=>a.date.localeCompare(b.date));
    }
    st.onboarded=true;
    save(st);
    $('#welcomeModal').style.display='none';
    alert('✅ Zapisano dane startowe');
  }
  function openOnboarding(){ $('#welcomeModal').style.display='flex'; }

  /* ===== Photos (limit 5/day) + auto face blur + modal 720p ===== */
  function today(){ return new Date().toISOString().slice(0,10); }
  function addPhotos(files){
    const st=load();
    const date=$('#photoDate').value || today();
    const perDay=st.photos.filter(p=>p.date===date).length;
    const allowed=Math.max(0, 5 - perDay);
    if(allowed<=0){ alert('Limit 5 zdjęć na ten dzień.'); return; }
    Array.from(files).slice(0,allowed).forEach(file=>{
      const fr=new FileReader();
      fr.onload=()=>{
        const img=new Image();
        img.onload=()=>{
          const W=img.width,H=img.height;
          const c=document.createElement('canvas'); c.width=W; c.height=H;
          const ctx=c.getContext('2d'); ctx.drawImage(img,0,0);
          // simple blur band for face zone (top 22% middle width)
          const faceH=Math.round(H*0.22);
          ctx.filter='blur(14px)'; ctx.fillStyle='rgba(0,0,0,0.1)';
          ctx.fillRect(Math.round(W*0.2), 0, Math.round(W*0.6), faceH);
          ctx.filter='none';
          const data=c.toDataURL('image/jpeg',0.92);
          st.photos.push({date, ts:Date.now(), data});
          save(st); renderGallery();
        };
        img.src=fr.result;
      };
      fr.readAsDataURL(file);
    });
  }
  function renderGallery(){
    const st=load();
    const box=$('#photoGallery');
    const list=st.photos.slice(-12);
    box.innerHTML='';
    if(!list.length){ box.textContent='Brak zdjęć.'; return; }
    list.forEach(p=>{
      const i=document.createElement('img'); i.src=p.data; i.title=p.date;
      i.addEventListener('click',ev=>{
        if(ev.altKey){
          if(confirm('Usunąć to zdjęcie?')){
            const s=load();
            s.photos=s.photos.filter(x=>x.ts!==p.ts);
            save(s); renderGallery();
          }
          return;
        }
        openModal(p.data);
      });
      box.appendChild(i);
    });
  }
  function openModal(src){
    const i=new Image();
    i.onload=()=>{
      const maxW=1280, maxH=720; let w=i.width, h=i.height, r=Math.min(maxW/w, maxH/h);
      if(r<1){ w=Math.round(w*r); h=Math.round(h*r); }
      const c=document.createElement('canvas'); c.width=w; c.height=h;
      c.getContext('2d').drawImage(i,0,0,w,h);
      $('#modalImg').src=c.toDataURL('image/jpeg',0.95);
      $('#photoModal').style.display='flex';
    };
    i.src=src;
  }

  /* ===== Meals (demo) ===== */
  function renderMeals(){
    const B=['Owsianka P40/C60/F15','Jajecznica P35/C10/F20','Skyr + płatki P30/C40/F5'];
    const L=['Kurczak + ryż P45/C70/F10','Łosoś + ziemniaki P40/C50/F20','Indyk + makaron P40/C60/F12'];
    const D=['Sałatka grecka P20/C15/F25','Tortilla z indykiem P35/C45/F10','Twarożek + owoce P25/C25/F5'];
    const mk=a=>a.map(x=>'<div>• '+x+'</div>').join('');
    $('#bMeals').innerHTML=mk(B);
    $('#lMeals').innerHTML=mk(L);
    $('#dMeals').innerHTML=mk(D);
  }

  /* ===== Chart (demo) ===== */
  function renderChart(){
    const c=document.getElementById('mChart'), ctx=c.getContext('2d');
    ctx.clearRect(0,0,c.width,c.height);
    const dark=document.body.classList.contains('dark');
    const cols=dark?['#60a5fa','#22c55e','#fbbf24','#f472b6']:['#2563eb','#16a34a','#d97706','#db2777'];
    const axis=dark?'#9fb0c9':'#64748b', grid=dark?'#334155':'#e5e7eb';
    const pad=26, top=14, right=8, bottom=20, W=c.width-pad-right, H=c.height-top-bottom;
    const yMin=60,yMax=100;
    ctx.strokeStyle=grid; ctx.fillStyle=axis; ctx.lineWidth=1;
    for(let i=0;i<=4;i++){ const t=i/4, y=top+H-t*H; ctx.beginPath(); ctx.moveTo(pad,y); ctx.lineTo(pad+W,y); ctx.stroke(); ctx.fillText((yMin+t*(yMax-yMin)).toFixed(0),4,y+3);}
    ctx.fillText('demo', pad, c.height-4);
    ctx.strokeStyle=cols[0]; ctx.lineWidth=2; ctx.beginPath();
    for(let k=0;k<10;k++){ const x=pad+(k/9)*W; const y=top+(1-((70+Math.sin(k)*5) - yMin)/(yMax-yMin))*H; if(k===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); }
    ctx.stroke();
  }

  /* ===== Start prefs binding ===== */
  function bindStart(){
    $('#suppWant').addEventListener('change',()=>{
      const v=$('#suppWant').value;
      document.getElementById('suppLevelWrap').classList.toggle('hidden', v!=='tak');
      const st=load(); st.prefs.suppWant=v; save(st);
    });
    $('#trainGoal').addEventListener('change',()=>{ const st=load(); st.prefs.goal=$('#trainGoal').value; save(st); });
    $('#trainPlace').addEventListener('change',()=>{ const st=load(); st.prefs.place=$('#trainPlace').value; save(st); });
    $('#suppLevel').addEventListener('change',()=>{ const st=load(); st.prefs.suppLevel=$('#suppLevel').value; save(st); });
    $('#tdeeActivity').addEventListener('change',()=>{ const st=load(); st.prefs.activity=+$('#tdeeActivity').value; save(st); });
  }

  /* ===== Options save folder ===== */
  function saveFolder(){
    const st=load();
    st.opts.dataFolder = $('#dataFolder').value.trim();
    save(st);
    $('#folderInfo').textContent = st.opts.dataFolder ? ('Ustawiono folder: ' + st.opts.dataFolder) : 'Brak skonfigurowanego folderu.';
    alert('✅ Zapisano folder danych lokalnych');
  }

  /* ===== Init ===== */
  function init(){
    initTabs(); bindStart();
    $('#btnTheme').addEventListener('click', toggleTheme);
    $('#photoDate').value=(new Date()).toISOString().slice(0,10);
    $('#photoFile').addEventListener('change', e=>{ if(e.target.files?.length) addPhotos(e.target.files); });
    $('#closeModal')?.addEventListener('click', ()=>$('#photoModal').style.display='none');
    $('#photoModal')?.addEventListener('click', e=>{ if(e.target.id==='photoModal') $('#photoModal').style.display='none'; });
    $('#btnSaveFolder').addEventListener('click', saveFolder);
    $('#btnShowOnboarding').addEventListener('click', openOnboarding);
    $('#btnEditOnboarding').addEventListener('click', openOnboarding);
    $('#btnTDEE').addEventListener('click', openOnboarding);
    $('#btnCalcTDEE').addEventListener('click', calcTDEEOnce);
    $('#btnSaveOnboarding').addEventListener('click', saveOnboarding);

    // Set info
    $('#dateInfo').textContent=(new Date()).toLocaleString();
    // Prefill inputs from store
    const st=load();
    $('#trainGoal').value=st.prefs.goal||'kondycja';
    $('#trainPlace').value=st.prefs.place||'silownia';
    $('#suppWant').value=st.prefs.suppWant||'nie';
    $('#suppLevel').value=st.prefs.suppLevel||'minimalna';
    $('#suppLevelWrap').classList.toggle('hidden', st.prefs.suppWant!=='tak');
    $('#tdeeActivity').value=st.prefs.activity||1.55;
    $('#dataFolder').value=st.opts.dataFolder||'';

    renderMeals(); renderGallery(); renderChart(); applyTheme();

    // first-run
    if(!st.onboarded){ $('#welcomeModal').style.display='flex'; }
  }
  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', init, {once:true}); else init();
})();
</script>
</body>
</html>
